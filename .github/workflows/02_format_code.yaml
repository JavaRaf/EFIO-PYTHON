name: 02_format_code

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

permissions:
    contents: write

jobs:
    format:
        runs-on: ubuntu-24.04

        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        steps:
            - name: Checkout do reposit√≥rio
              uses: actions/checkout@v4 

            - uses: actions/setup-python@v4
              with:
                python-version: "3.13"

            - name: Cache pip
              uses: actions/cache@v4
              with:
                path: ~/.cache/pip
                key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
                restore-keys: |
                  ${{ runner.os }}-pip-

            - name: Update pip
              run: python -m pip install --upgrade pip

            - name: Install Ruff
              run: python -m pip install ruff

            - name: Check syntax
              run: ruff check .

            - name: Format and Fix Code
              run: |
                  ruff format .
                  ruff check --fix .

            - name: Check for changes
              id: git_diff
              run: |
                  git diff --exit-code || echo "Changes detected"

            - name: Commit changes
              if: steps.git_diff.outputs.changes == 'Changes detected'
              uses: stefanzweifel/git-auto-commit-action@v5
              with:
                  skip_dirty_check: false
                  commit_message: "chore: format code with ruff"
                  branch: main
                  file_pattern: "*.py"
